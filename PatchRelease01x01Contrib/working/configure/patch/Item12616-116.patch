Item12616: Foswiki encounters perl errors in 5.18, 5.19 

Addresses a crash in Foswiki::Attach, and sort ordering issues caused by perl Hash order changes.

~~~PATCH c67083bf1b9a7ab3a078b4ee1c5ef7f0:3be703fb43e105a1bd6f213befcb5a73 lib/Foswiki/Attach.pm (Foswiki-1.1.6)
diff --git lib/Foswiki/Attach.pm lib/Foswiki/Attach.pm
index bb2396b..63eadc3 100644
--- lib/Foswiki/Attach.pm
+++ lib/Foswiki/Attach.pm
@@ -199,7 +199,12 @@ sub _expandAttrs {
         return $comment;
     }
     elsif ( $attr eq 'ATTRS' ) {
-        return $info->{attr} or "&nbsp;";
+        if ( $info->{attr} ) {
+            return $info->{attr};
+        }
+        else {
+            return "&nbsp;";
+        }
     }
     elsif ( $attr eq 'FILE' ) {
         return $file;
~~~PATCH 7c41bb4ed3c7f01eaf0ba59a698b6eeb:e7e51a8b31e987c26cab7dfe6976d1d4 lib/Foswiki/Configure/Package.pm (Foswiki-1.1.6)
diff --git lib/Foswiki/Configure/Package.pm lib/Foswiki/Configure/Package.pm
index 4c82931..b2b467f 100644
--- lib/Foswiki/Configure/Package.pm
+++ lib/Foswiki/Configure/Package.pm
@@ -674,7 +674,7 @@ sub _installAttachments {
     my $feedback  = '';
     my $errors    = '';
 
-    foreach my $key ( keys %{ $this->{_manifest}{ATTACH}{$webTopic} } ) {
+    foreach my $key ( sort keys %{ $this->{_manifest}{ATTACH}{$webTopic} } ) {
         my $file = $this->{_manifest}->{ATTACH}->{$webTopic}->{$key};
         my $tfile =
           Foswiki::Configure::Util::mapTarget( $this->{_root}, $file );
@@ -889,7 +889,7 @@ sub listFiles {
     my ( $this, $installed ) = @_;
 
     my @files;
-    foreach my $key ( keys( %{ $this->{_manifest} } ) ) {
+    foreach my $key ( sort keys( %{ $this->{_manifest} } ) ) {
         next if ( $key eq 'ATTACH' );
         if ($installed) {
             my $target =
@@ -901,7 +901,7 @@ sub listFiles {
             push( @files, $key );
         }
     }
-    return sort(@files);
+    return @files;
 }
 
 =begin TML
@@ -987,7 +987,7 @@ sub uninstall {
     }
 
     # foreach file in the manifest, remove the file.
-    foreach my $key ( keys( %{ $this->{_manifest} } ) ) {
+    foreach my $key ( sort keys( %{ $this->{_manifest} } ) ) {
 
         next if ( $key eq 'ATTACH' );
 
~~~PATCH ff22a5835959f797746b9d63ad28496c:d4b0fdea01ca7693f76ea2f2967271d4 lib/Foswiki/Search.pm (Foswiki-1.1.6)
diff --git lib/Foswiki/Search.pm lib/Foswiki/Search.pm
index b1042a4..287e969 100644
--- lib/Foswiki/Search.pm
+++ lib/Foswiki/Search.pm
@@ -1137,6 +1137,19 @@ sub formatResult {
         delete $customKeys->{$key};
     }
 
+    #SMELL:  Because hash order is not predictable,  any user supplied
+    # format which might contain other $format tokens must be expanded first,
+    # otherwise the results are unpredictable.
+    # For example,  pagerformat contains $ntopics.  If $ntopics expands first,
+    # then pagerformat,  then ntopics will remain un-expanded in the output.
+    # Since key processing order is unpredictable, add any potentially nested
+    # keys here
+    foreach my $key ('\$pager') {
+        next unless defined $customKeys->{$key};
+        $out =~ s/$key/&{$customKeys->{$key}}()/ges;
+        delete $customKeys->{$key};
+    }
+
     foreach my $key ( keys(%$customKeys) ) {
         $out =~ s/$key/&{$customKeys->{$key}}()/ges;
     }
~~~PATCH 2e6a2adaa691439501881e4008028e77:8d9125d898a5d4f630c432fa83abeed2 lib/Foswiki/UI/Register.pm (Foswiki-1.1.6)
diff --git lib/Foswiki/UI/Register.pm lib/Foswiki/UI/Register.pm
index cd78dd1..2981e60 100644
--- lib/Foswiki/UI/Register.pm
+++ lib/Foswiki/UI/Register.pm
@@ -1176,7 +1176,8 @@ sub _populateUserTopicForm {
     return ( $meta, '' ) unless $form;
 
     foreach my $field ( @{ $form->getFields() } ) {
-        foreach my $fd ( @{ $data->{form} } ) {
+        foreach my $fd ( sort { $a->{name} cmp $b->{name} } @{ $data->{form} } )
+        {
             next unless $fd->{name} eq $field->{name};
             next if $SKIPKEYS{ $fd->{name} };
             my $item = $meta->get( 'FIELD', $fd->{name} );
@@ -1198,7 +1199,7 @@ sub _populateUserTopicForm {
         }
     }
     my $leftoverText = '';
-    foreach my $fd ( @{ $data->{form} } ) {
+    foreach my $fd ( sort { $a->{name} cmp $b->{name} } @{ $data->{form} } ) {
         unless ( $inform{ $fd->{name} } || $SKIPKEYS{ $fd->{name} } ) {
             $leftoverText .= "   * $fd->{name}: $fd->{value}\n";
         }
@@ -1210,7 +1211,7 @@ sub _populateUserTopicForm {
 sub _getRegFormAsTopicContent {
     my $data = shift;
     my $text;
-    foreach my $fd ( @{ $data->{form} } ) {
+    foreach my $fd ( sort { $a->{name} cmp $b->{name} } @{ $data->{form} } ) {
         next if $SKIPKEYS{ $fd->{name} };
         my $title = $fd->{name};
         $title =~ s/([a-z0-9])([A-Z0-9])/$1 $2/go;    # Spaced
@@ -1291,7 +1292,7 @@ sub _buildConfirmationEmail {
     #       like in multi-part mime - txt & html
     my ( $before, $after ) = split( /%FORMDATA%/, $templateText );
     $before .= $loginName;
-    foreach my $fd ( @{ $data->{form} } ) {
+    foreach my $fd ( sort { $a->{name} cmp $b->{name} } @{ $data->{form} } ) {
         my $name  = $fd->{name};
         my $value = $fd->{value};
 
@@ -1311,7 +1312,6 @@ sub _buildConfirmationEmail {
     $templateText =~ s/( ?) *<\/?(nop|noautolink)\/?>\n?/$1/gois;
 
     # remove <nop> and <noautolink> tags
-
     return $templateText;
 }
 
@@ -1562,7 +1562,7 @@ sub _validateRegistration {
         );
     }
     my @missing = ();
-    foreach my $fd ( @{ $data->{form} } ) {
+    foreach my $fd ( sort { $a->{name} cmp $b->{name} } @{ $data->{form} } ) {
         if ( ( $fd->{required} ) && ( !$fd->{value} ) ) {
             push( @missing, $fd->{name} );
         }
